{% extends "base.html" %}

{% block title %}Data Management - Sahaaj Pathshalas KPI{% endblock %}

{% block content %}
<!-- Professional Hero Section -->
<div class="row mb-5" data-aos="fade-up">
    <div class="col-12">
        <div class="card">
            <div class="card-body text-center py-5">
                <h1 class="display-4 fw-bold text-primary mb-3">
                    <i class="fas fa-database me-3"></i>
                    Data Management
                </h1>
                <p class="lead text-muted mb-0">
                    View, edit, and manage all tutor entries with advanced search and filtering
                </p>
            </div>
        </div>
    </div>
</div>

<!-- Flash Messages -->
{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        <div class="row mb-4">
            <div class="col-12">
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'error' if category == 'error' else category }} alert-dismissible fade show" role="alert" data-aos="fade-down">
                        <i class="fas fa-{{ 'exclamation-triangle' if category == 'error' else 'check-circle' }} me-2"></i>
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            </div>
        </div>
    {% endif %}
{% endwith %}

<!-- Search and Filter Section -->
<div class="row mb-4" data-aos="fade-up" data-aos-delay="100">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-search me-2"></i>
                    Search & Filter Entries
                </h5>
            </div>
            <div class="card-body">
                <form method="GET" action="{{ url_for('data_management') }}" class="row g-3">
                    <div class="col-md-3">
                        <label for="search_name" class="form-label">Tutor Name</label>
                        <input type="text" class="form-control" id="search_name" name="search_name" 
                               value="{{ search_name }}" placeholder="Search by name...">
                    </div>
                    <div class="col-md-3">
                        <label for="search_center" class="form-label">Center Name</label>
                        <input type="text" class="form-control" id="search_center" name="search_center" 
                               value="{{ search_center }}" placeholder="Search by center...">
                    </div>
                    <div class="col-md-2">
                        <label for="search_section" class="form-label">Section</label>
                        <select class="form-control" id="search_section" name="search_section">
                            <option value="">All Sections</option>
                            <option value="Junior" {{ 'selected' if search_section == 'Junior' }}>Junior</option>
                            <option value="Senior" {{ 'selected' if search_section == 'Senior' }}>Senior</option>
                            <option value="Both" {{ 'selected' if search_section == 'Both' }}>Both</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label for="date_from" class="form-label">From Date</label>
                        <input type="date" class="form-control" id="date_from" name="date_from" 
                               value="{{ date_from }}">
                    </div>
                    <div class="col-md-2">
                        <label for="date_to" class="form-label">To Date</label>
                        <input type="date" class="form-control" id="date_to" name="date_to" 
                               value="{{ date_to }}">
                    </div>
                    <div class="col-12">
                        <button type="submit" class="btn btn-primary me-2">
                            <i class="fas fa-search me-1"></i>
                            Search
                        </button>
                        <a href="{{ url_for('data_management') }}" class="btn btn-secondary">
                            <i class="fas fa-times me-1"></i>
                            Clear
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Data Management Actions -->
<div class="row mb-4" data-aos="fade-up" data-aos-delay="200">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <h6 class="mb-0">
                            <i class="fas fa-list me-2"></i>
                            Showing {{ pagination.total }} entries
                        </h6>
                    </div>
                    <div class="col-md-6 text-end">
                        <button class="btn btn-outline-danger me-2" id="bulk-delete-btn" style="display: none;">
                            <i class="fas fa-trash me-1"></i>
                            Delete Selected
                        </button>
                        <a href="{{ url_for('tutor_input') }}" class="btn btn-success">
                            <i class="fas fa-plus me-1"></i>
                            Add New Entry
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Data Table -->
<div class="row" data-aos="fade-up" data-aos-delay="300">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-table me-2"></i>
                    Tutor Entries
                </h5>
            </div>
            <div class="card-body">
                {% if tutors %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>
                                        <input type="checkbox" id="select-all" class="form-check-input">
                                    </th>
                                    <th>Tutor Name</th>
                                    <th>Center</th>
                                    <th>Section</th>
                                    <th>Students</th>
                                    <th>Date</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for tutor in tutors %}
                                <tr>
                                    <td>
                                        <input type="checkbox" class="form-check-input entry-checkbox" value="{{ tutor.id }}">
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="avatar-sm me-3">
                                                <i class="fas fa-user-circle text-primary"></i>
                                            </div>
                                            <div>
                                                <div class="fw-medium">{{ tutor.name }}</div>
                                            </div>
                                        </div>
                                    </td>
                                    <td>{{ tutor.center_name }}</td>
                                    <td>
                                        <span class="badge bg-primary">{{ tutor.section }}</span>
                                    </td>
                                    <td>
                                        <span class="fw-medium">{{ tutor.total_students }}</span>
                                    </td>
                                    <td>{{ tutor.attendance_date.strftime('%Y-%m-%d') }}</td>
                                    <td>{{ tutor.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            <button type="button" class="btn btn-sm btn-outline-primary" 
                                                    onclick="viewEntry({{ tutor.id }})" title="View Details">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <a href="{{ url_for('edit_entry', entry_id=tutor.id) }}" 
                                               class="btn btn-sm btn-outline-warning" title="Edit Entry">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                            <button type="button" class="btn btn-sm btn-outline-danger" 
                                                    onclick="confirmDelete({{ tutor.id }}, '{{ tutor.name }}', '{{ tutor.center_name }}', '{{ tutor.attendance_date.strftime('%Y-%m-%d') }}')" 
                                                    title="Delete Entry">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    {% if pagination.pages > 1 %}
                    <nav aria-label="Data pagination" class="mt-4">
                        <ul class="pagination justify-content-center">
                            {% if pagination.has_prev %}
                                <li class="page-item">
                                    <a class="page-link" href="{{ url_for('data_management', page=pagination.prev_num, search_name=search_name, search_center=search_center, search_section=search_section, date_from=date_from, date_to=date_to) }}">
                                        <i class="fas fa-chevron-left"></i>
                                    </a>
                                </li>
                            {% endif %}
                            
                            {% for page_num in pagination.iter_pages() %}
                                {% if page_num %}
                                    {% if page_num != pagination.page %}
                                        <li class="page-item">
                                            <a class="page-link" href="{{ url_for('data_management', page=page_num, search_name=search_name, search_center=search_center, search_section=search_section, date_from=date_from, date_to=date_to) }}">
                                                {{ page_num }}
                                            </a>
                                        </li>
                                    {% else %}
                                        <li class="page-item active">
                                            <span class="page-link">{{ page_num }}</span>
                                        </li>
                                    {% endif %}
                                {% else %}
                                    <li class="page-item disabled">
                                        <span class="page-link">...</span>
                                    </li>
                                {% endif %}
                            {% endfor %}
                            
                            {% if pagination.has_next %}
                                <li class="page-item">
                                    <a class="page-link" href="{{ url_for('data_management', page=pagination.next_num, search_name=search_name, search_center=search_center, search_section=search_section, date_from=date_from, date_to=date_to) }}">
                                        <i class="fas fa-chevron-right"></i>
                                    </a>
                                </li>
                            {% endif %}
                        </ul>
                    </nav>
                    {% endif %}
                {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No entries found</h5>
                        <p class="text-muted">Try adjusting your search criteria or add a new entry.</p>
                        <a href="{{ url_for('tutor_input') }}" class="btn btn-primary">
                            <i class="fas fa-plus me-1"></i>
                            Add New Entry
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Entry Details Modal -->
<div class="modal fade" id="entryModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-user me-2"></i>
                    Entry Details
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="entryModalBody">
                <!-- Content will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <a href="#" class="btn btn-warning" id="editEntryBtn">
                    <i class="fas fa-edit me-1"></i>
                    Edit Entry
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Confirm Deletion
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this entry?</p>
                <div class="alert alert-warning">
                    <strong>Entry Details:</strong><br>
                    <span id="deleteEntryDetails"></span>
                </div>
                <p class="text-danger"><small>This action cannot be undone.</small></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form method="POST" id="deleteForm" style="display: inline;">
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-trash me-1"></i>
                        Delete Entry
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Professional Data Management Functions
let selectedEntries = [];

// Select all functionality
document.getElementById('select-all').addEventListener('change', function() {
    const checkboxes = document.querySelectorAll('.entry-checkbox');
    checkboxes.forEach(checkbox => {
        checkbox.checked = this.checked;
        if (this.checked) {
            selectedEntries.push(parseInt(checkbox.value));
        } else {
            selectedEntries = [];
        }
    });
    updateBulkDeleteButton();
});

// Individual checkbox handling
document.addEventListener('change', function(e) {
    if (e.target.classList.contains('entry-checkbox')) {
        const entryId = parseInt(e.target.value);
        
        if (e.target.checked) {
            if (!selectedEntries.includes(entryId)) {
                selectedEntries.push(entryId);
            }
        } else {
            selectedEntries = selectedEntries.filter(id => id !== entryId);
        }
        
        updateBulkDeleteButton();
        updateSelectAllCheckbox();
    }
});

function updateBulkDeleteButton() {
    const bulkDeleteBtn = document.getElementById('bulk-delete-btn');
    if (selectedEntries.length > 0) {
        bulkDeleteBtn.style.display = 'inline-block';
        bulkDeleteBtn.innerHTML = `<i class="fas fa-trash me-1"></i>Delete Selected (${selectedEntries.length})`;
    } else {
        bulkDeleteBtn.style.display = 'none';
    }
}

function updateSelectAllCheckbox() {
    const selectAllCheckbox = document.getElementById('select-all');
    const allCheckboxes = document.querySelectorAll('.entry-checkbox');
    const checkedCheckboxes = document.querySelectorAll('.entry-checkbox:checked');
    
    if (checkedCheckboxes.length === 0) {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = false;
    } else if (checkedCheckboxes.length === allCheckboxes.length) {
        selectAllCheckbox.checked = true;
        selectAllCheckbox.indeterminate = false;
    } else {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = true;
    }
}

// View entry details
async function viewEntry(entryId) {
    try {
        const response = await fetch(`/api/entry/${entryId}`);
        const data = await response.json();
        
        if (response.ok) {
            const modalBody = document.getElementById('entryModalBody');
            const editBtn = document.getElementById('editEntryBtn');
            
            modalBody.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="text-primary">Tutor Information</h6>
                        <p><strong>Name:</strong> ${data.name}</p>
                        <p><strong>Center:</strong> ${data.center_name}</p>
                        <p><strong>Section:</strong> <span class="badge bg-primary">${data.section}</span></p>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-primary">Attendance Details</h6>
                        <p><strong>Students:</strong> ${data.total_students}</p>
                        <p><strong>Date:</strong> ${data.attendance_date}</p>
                        <p><strong>Created:</strong> ${data.created_at}</p>
                    </div>
                </div>
            `;
            
            editBtn.href = `/edit-entry/${entryId}`;
            
            const modal = new bootstrap.Modal(document.getElementById('entryModal'));
            modal.show();
        } else {
            showError('Failed to load entry details');
        }
    } catch (error) {
        console.error('Error loading entry:', error);
        showError('Failed to load entry details');
    }
}

// Confirm deletion
function confirmDelete(entryId, name, center, date) {
    const deleteDetails = document.getElementById('deleteEntryDetails');
    const deleteForm = document.getElementById('deleteForm');
    
    deleteDetails.innerHTML = `
        <strong>Name:</strong> ${name}<br>
        <strong>Center:</strong> ${center}<br>
        <strong>Date:</strong> ${date}
    `;
    
    deleteForm.action = `/delete-entry/${entryId}`;
    
    const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
    modal.show();
}

// Bulk delete functionality
document.getElementById('bulk-delete-btn').addEventListener('click', async function() {
    if (selectedEntries.length === 0) {
        showError('No entries selected');
        return;
    }
    
    if (!confirm(`Are you sure you want to delete ${selectedEntries.length} selected entries? This action cannot be undone.`)) {
        return;
    }
    
    try {
        const response = await fetch('/bulk-delete', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                entry_ids: selectedEntries
            })
        });
        
        const result = await response.json();
        
        if (response.ok) {
            showSuccess(result.message);
            selectedEntries = [];
            updateBulkDeleteButton();
            // Reload page to refresh data
            setTimeout(() => {
                window.location.reload();
            }, 1500);
        } else {
            showError(result.error || 'Failed to delete entries');
        }
    } catch (error) {
        console.error('Error deleting entries:', error);
        showError('Failed to delete entries');
    }
});

// Professional notification functions
function showSuccess(message) {
    const alert = document.createElement('div');
    alert.className = 'alert alert-success alert-dismissible fade show';
    alert.innerHTML = `
        <i class="fas fa-check-circle me-2"></i>
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.querySelector('main').insertBefore(alert, document.querySelector('main').firstChild);
    
    setTimeout(() => {
        if (alert.parentNode) {
            alert.remove();
        }
    }, 5000);
}

function showError(message) {
    const alert = document.createElement('div');
    alert.className = 'alert alert-error alert-dismissible fade show';
    alert.innerHTML = `
        <i class="fas fa-exclamation-triangle me-2"></i>
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.querySelector('main').insertBefore(alert, document.querySelector('main').firstChild);
    
    setTimeout(() => {
        if (alert.parentNode) {
            alert.remove();
        }
    }, 5000);
}

// Auto-refresh data every 30 seconds
setInterval(() => {
    if (!document.hidden) {
        // Only refresh if there are no active modals
        const activeModals = document.querySelectorAll('.modal.show');
        if (activeModals.length === 0) {
            window.location.reload();
        }
    }
}, 30000);
</script>
{% endblock %}
